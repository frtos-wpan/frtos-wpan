@@@ WIP. branch names will change.

@@@ WIP. the github setup is a bit awkward. may change in the future.

See README.md for a brief project overview.

License
-------

Unless stated otherwise, all code in this project is developed by 
Werner Almesberger for Actility S.A., and licensed under LGPLv2 by 
Actility S.A.


System setup
------------

Package names are for Ubuntu 13.04.

git-svn is used to track the FreeRTOS upstream (only needed if
maintaining the SVN-to-git tracking repository):

# apt-get install git-svn

The cross-compilation toolchain:

# apt-get install gcc-arm-linux-gnueabi

We use dfu-util to load new firmware into the evaluation boards:

# apt-get install dfu-util

Other tools we need (some may already be installed):

# apt-get install git make unzip wget


arm-none-eabi toolchain
-----------------------

# apt-get remove binutils-arm-linux-gnueabi cpp-4.7-arm-linux-gnueabi
# apt-get remove cpp-arm-linux-gnueabi gcc-4.7-arm-linux-gnueabi
# apt-get remove gcc-4.7-arm-linux-gnueabi-base gcc-arm-linux-gnueabi

@@@ # apt-get install libmpfr-dev libmpc-dev libgmp-dev

% wget http://ftp.gnu.org/gnu/binutils/binutils-2.23.2.tar.bz2
% tar xfj binutils-2.23.2.tar.bz2
% cd binutils-2.23.2
% mkdir obj
% cd obj
% ../configure --target=arm-none-eabi -enable-interwork --enable-multilib
% make -j5
% make install
% cd ../..

% wget ftp://sourceware.org/pub/newlib/newlib-2.0.0.tar.gz
% tar xfz newlib-2.0.0.tar.gz

% wget http://ftp.gnu.org/gnu/gcc/gcc-4.7.3/gcc-4.7.3.tar.bz2
% tar xfj gcc-4.7.3.tar.bz2
% cd gcc-4.7.3
% mkdir obj
% cd obj
% ../configure --target=arm-none-eabi --enable-interwork --enable-languages=c \
  --with-newlib --with-headers=../../newlib-2.0.0/newlib/libc/include
% make -j5
% make install
% cd ../..

% wget ftp://ftp.gnu.org/gnu/gdb/gdb-7.6.tar.bz2
% tar xfj gdb-7.6.tar.bz2
% cd gdb-7.6
% ./configure --target=arm-none-eabi --enable-interwork --enable-multilib
% make -j5
% make install
% cd ..

% wget 
% cd newlib-2.0.0
% mkdir obj
% cd obj
% ../configure --target=arm-none-eabi --enable-interwork --enable-multilib
% make -j5
% make install
% cd ../..


Setting up a FreeRTOS SVN-to-git repository
-------------------------------------------

Note: skip the "git clone ...freertos.git" step in the next section
if you do this.

@@@ verify this sequence

% mkdir freertos
% cd freertos
% git init
% git svn fetch
% git checkout -b master
% git merge --ff-only trunk
% git remote add origin git@github.com:frtos-wpan/freertos.git
#% git push -u origin master
% git config push.default matching
% git push --mirror


Setting up the repositories
---------------------------

% git clone git@github.com:frtos-wpan/frtos-wpan.git 
% git clone git@github.com:frtos-wpan/contiki.git
% git clone git@github.com:frtos-wpan/freertos.git

% cd frtos-wpan
% make

% cd ../contiki
% git remote add upstream https://github.com/contiki-os/contiki.git


Updating the repositories
-------------------------

frtos-wpan:

% cd frtos-wpan
% git pull

Contiki (frtos-wpan fork):

% cd contiki
% git pull

Contiki (upstream):

% cd contiki
% git fetch upstream
% git checkout master
% git merge upstream/master
% git checkout frtos
% git merge master

FreeRTOS (from git):

% cd freertos
% git pull

FreeRTOS (from SVN):

% cd freertos
% git svn fetch
% git merge --ff-only trunk


Transitory contiki-outoftree repository
---------------------------------------

% git clone git@github.com:frtos-wpan/contiki-outoftree.git
% git submodule init
% git submodule update
% git remote add upstream https://github.com/karlp/contiki-outoftree.git

% git fetch upstream
% git submodule update
% git checkout master
% git merge upstream/master


Caching the data sheets
-----------------------

Install "dsv" from
http://projects.qi-hardware.com/index.php/p/eda-tools/source/tree/master/dsv
for example,

% git clone git@projects.qi-hardware.com:eda-tools.git
% cp eda-tools/dsv/dsv /usr/local/bin

Download and cache the data sheets:

% cd frtos-wpan
% make

After that, you can access data sheets releveant to the project by going
to any directory under frtos-wpan and invoking "dsv NAME" there. Just
"dsv" lists the available names. The most important ones:

  eval	documentation of the Olimex STM32-E407 data sheet
  f400	STM32F4xx reference manual
  m4	STM32F4xx data sheet
  m4p	Cortex M4 programming manual

@@@ some of the abbreviations are not very good and may change in the
future.


Setting up the Olimex STM32-E407 board
--------------------------------------

- install feet and headers at will (the feet don't enter easily. Twisting
  them helps. The material seems strong enough that twisting doesn't
  shear off the nipples. Once inserted, let the rubber relax for a moment,
  then push it in some more.)

- receive power from USB-OTG1:
  move the PWR_SEL jumper (close to the DC connectors) from position
  1-2 (near the battery connector) to position 7-8 (in the large
  capacitors)

- to boot into DFU mode, move the jumper on B0_0 (near the UEXT connector)
  to position B0_1

- plug mini-USB into USB-OTG1, next to the Ethernet connector. The
  board should now enumerate as 0483:df11.


The FreeRTOS demo
-----------------

The demo runs on the Olimex STM32-E407. It

- blinks the LED, and

- prints "hello <number>" on UART6.TX at 19200 bps, where <number> is
  a sequence number. UART6 is available on the UEXT connector.

  A simple serial console utility can be found here:
  http://projects.qi-hardware.com/index.php/p/wernermisc/source/tree/master/neocon

% cd FreeRTOS/Demo/E407
% make
<bridge B0_1 and reset>
% make dfu
<move jumper back to B0_0 and reset again>

Note that the first "make" will download the ST "demonstration builder
platform" and therefore needs Internet access.


The Contiki demo
----------------

The demo runs on the Olimex STM32-E407. It

- TBD

% cd contiki-outoftree
% make TARGET=stm32ldiscovery PREFIX=arm-linux-gnueabi -C libopencm3
% make TARGET=stm32ldiscovery PREFIX=arm-linux-gnueabi
